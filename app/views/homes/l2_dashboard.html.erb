<div class="container-fluid" style="text-align: left;">
    <h3 style="padding:10px;font-weight: bolder;">Apex-Commitee's Dashboard</h3>
</div>

<div class="content" style="margin-top:0px; min-height: 600px !important;">
    <div class="container-fluid" id="">
        <div class='card'>
            <div class='card-header' data-background-color=blue>
                <ul class="nav nav-tabs">
                    <li class='active'><a data-toggle="tab" class='tab' id='btnhome'  onclick='doSwitch("home")'>The Most Inspiring Leader</a></li>
                    <li><a data-toggle="tab" class='tab' id='btnmenu1' onclick='doSwitch("menu1")'>The Best Employee</a></li>
                    <li><a data-toggle="tab" class='tab' id='btnmenu2'  onclick='doSwitch("menu2")'>The Most Innovative Employee</a></li>
                    <li><a data-toggle="tab" class='tab' id='btnmenu3' onclick='doSwitch("menu3")'>The Best Cross-Function Team</a></li>
                    <li><a data-toggle="tab" class='tab' id='btnmenu4' onclick='doSwitch("menu4")'><b>Final Verdict</b></a></li>
                </ul>
            </div>
            <div class='card-content'>
                <div class="tab-content">
                    <div id="menu4" class="tab-pane fade">
                    <h3>Enter your final comments for Chairman's Approval</h3>
                    Select Award<br>
                    <%= select_tag "award", options_from_collection_for_select(@awards, 'id', 'title'), {id: "award"} %>
                    <br><br>
                        <textarea name='comments' id='comments'></textarea>
                        <button class='btn btn-lg btn-success' onclick="submitVerdict()">Update</button>
                    </div>
                    <div id="home" class="tab-pane fade in active">
                        <h3>The Most Inspiring Leader</h3>
                        <div class='row'>
                            <div class='col-md-12'>
                                <table class='table table-bordered datatable'>
                                    <thead>
                                        <th>Nominee Information</th>
                                        <!-- <th>Nominators</th>
                                        <th>Number of Nominations</th> -->
                                        <th>Average Points (Out of 18)</th>
                                        <th>Award Towards</th>
                                        <th>Recommended By</th>
                                        <th>Comments</th>
                                        <th>Justification & Attachments</th>
                                        <th>Action</th>
                                    </thead>
                                    <tbody>
                                        <% @most_inspiring_leaders_nominations.each do |nomination| %>
                                            <tr id=<%=  nomination.id %>>
                                                <% nominee = nomination.nominees.last.user %>
                                                <td>
                                                    <p>Name : <%= nominee.employee.name %></p>
                                                    <p>Employee ID : <%= nominee.employee.emp_code %></p>
                                                    <p>DOJ : 15-06-2017</p>
                                                    <p>Reporting Manager : <%= nominee.employee.reporting_manager %></p>
                                                    <p>Department : <%= nominee.employee.department %></p>
                                                    <p>Section : <%= nominee.employee.unit %></p>
                                                    <p>SBU : <%= nominee.employee.sbu %></p>
                                                    <p>Location :  <%= nominee.employee.location %></p>
                                                </td>
                                                <td class='action_td'><h2><%= nomination.ratings.map(&:value).reduce(&:+)%></h2></td>
                                                <td><%= raw(nomination.summary) %></td>
                                                <td>
                                                    <% if nomination.state != 'rejected' %>
                                                        <% nomination.approvers.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% else %>
                                                        <% nomination.rejectors.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% end%>
                                                </td>
                                                <td>
                                                    <%= nomination.state != 'rejected' ? raw(nomination.l1_approval_reason) : raw(nomination.l1_rejection_reason) %>
                                                </td>
                                                <td class='action_td'>
                                                    Justifications
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                    Attachments
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                </td>
                                                <td class='action_td'>
                                                    <% if nomination.state != 'approved' %>
                                                        <% if nomination.state != 'rejected' %>
                                                            <button class='btn btn-success btn-sm' onclick="approve(<%=  nomination.id %>)"> Approve <i class='material-icons'>done</i></button>
                                                            <br>
                                                            <button class='btn btn-danger btn-sm' onclick="reject(<%=  nomination.id %>) ">Reject <i class='material-icons'>clear</i></button>
                                                        <% else %>
                                                            <h5>Rejected</h5>
                                                        <% end %>
                                                    <% else %>
                                                        <h5>Approved</h5>
                                                    <% end %>
                                                </td>
                                            </tr>
                                        <% end %>
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="menu1" class="tab-pane fade">
                        <h3>The Best Employee</h3>
                        <div class='row'>
                            <div class='col-md-12'>
                                <table class='table table-bordered datatable'>
                                    <thead>
                                        <th>Nominee Information</th>
                                        <th>Average Points (Out of 18)</th>
                                        <th>Award Towards</th>
                                        <th>Recommended By</th>
                                        <th>Comments</th>
                                        <th>Justification & Attachments</th>
                                        <th>Action</th>
                                    </thead>
                                    <tbody>
                                        <% @best_employee_nominations.each do |nomination| %>
                                            <tr id=<%=  nomination.id %>>
                                                <% nominee = nomination.nominees.last.user %>
                                                <td>
                                                    <p>Name : <%= nominee.employee.name %></p>
                                                    <p>Employee ID : <%= nominee.employee.emp_code %></p>
                                                    <p>DOJ : 15-06-2017</p>
                                                    <p>Reporting Manager : <%= nominee.employee.reporting_manager %></p>
                                                    <p>Department : <%= nominee.employee.department %></p>
                                                    <p>Section : <%= nominee.employee.unit %></p>
                                                    <p>SBU : <%= nominee.employee.sbu %></p>
                                                    <p>Location :  <%= nominee.employee.location %></p>
                                                </td>
                                                <td class='action_td'><h2><%= nomination.ratings.map(&:value).reduce(&:+)%></h2></td>
                                                <td><%= raw(nomination.summary) %></td>
                                                <td>
                                                    <% if nomination.state != 'rejected' %>
                                                        <% nomination.approvers.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% else %>
                                                        <% nomination.rejectors.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% end%>
                                                </td>
                                                <td>
                                                    <%= nomination.state != 'rejected' ? raw(nomination.l1_approval_reason) : raw(nomination.l1_rejection_reason) %>
                                                </td>
                                                <td class='action_td'>
                                                    Justifications
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                    Attachments
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                </td>
                                                <td class='action_td'>
                                                    <% if nomination.state != 'approved' %>
                                                        <% if nomination.state != 'rejected' %>
                                                            <button class='btn btn-success btn-sm' onclick="approve(<%=  nomination.id %>)"> Approve <i class='material-icons'>done</i></button>
                                                            <br>
                                                            <button class='btn btn-danger btn-sm' onclick="reject(<%=  nomination.id %>) ">Reject <i class='material-icons'>clear</i></button>
                                                        <% else %>
                                                            <h5>Rejected</h5>
                                                        <% end %>
                                                    <% else %>
                                                        <h5>Approved</h5>
                                                    <% end %>
                                                </td>
                                            </tr>
                                        <% end %>
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>



                    <div id="menu2" class="tab-pane fade">
                        <h3>The Most Innovative Employee</h3>
                        <div class='row'>
                            <div class='col-md-12'>
                                <table class='table table-bordered datatable'>
                                    <thead>
                                        <th>Nominee Information</th>
                                        <th>Average Points (Out of 18)</th>
                                        <th>Award Towards</th>
                                        <th>Recommended By</th>
                                        <th>Comments</th>
                                        <th>Justification & Attachments</th>
                                        <th>Action</th>
                                    </thead>
                                    <tbody>
                                        <% @most_innovative_employee_nominations.each do |nomination| %>
                                            <tr id=<%=  nomination.id %>>
                                                <% nominee = nomination.nominees.last.user %>
                                                <td>
                                                    <p>Name : <%= nominee.employee.name %></p>
                                                    <p>Employee ID : <%= nominee.employee.emp_code %></p>
                                                    <p>DOJ : 15-06-2017</p>
                                                    <p>Reporting Manager : <%= nominee.employee.reporting_manager %></p>
                                                    <p>Department : <%= nominee.employee.department %></p>
                                                    <p>Section : <%= nominee.employee.unit %></p>
                                                    <p>SBU : <%= nominee.employee.sbu %></p>
                                                    <p>Location :  <%= nominee.employee.location %></p>
                                                </td>
                                                <td class='action_td'><h2><%= nomination.ratings.map(&:value).reduce(&:+)%></h2></td>
                                                <td><%= raw(nomination.summary) %></td>
                                                <td>
                                                    <% if nomination.state != 'rejected' %>
                                                        <% nomination.approvers.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% else %>
                                                        <% nomination.rejectors.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% end%>
                                                </td>
                                                <td>
                                                    <%= nomination.state != 'rejected' ? raw(nomination.l1_approval_reason) : raw(nomination.l1_rejection_reason) %>
                                                </td>
                                                <td class='action_td'>
                                                    Justifications
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                    Attachments
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                </td>
                                                <td class='action_td'>
                                                    <% if nomination.state != 'approved' %>
                                                        <% if nomination.state != 'rejected' %>
                                                            <button class='btn btn-success btn-sm' onclick="approve(<%=  nomination.id %>)"> Approve <i class='material-icons'>done</i></button>
                                                            <br>
                                                            <button class='btn btn-danger btn-sm' onclick="reject(<%=  nomination.id %>) ">Reject <i class='material-icons'>clear</i></button>
                                                        <% else %>
                                                            <h5>Rejected</h5>
                                                        <% end %>
                                                    <% else %>
                                                        <h5>Approved</h5>
                                                    <% end %>
                                                </td>
                                            </tr>
                                        <% end %>
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                    <div id="menu3" class="tab-pane fade">
                        <h3>The Best Cross-Functional Team</h3>
                        <div class='row'>
                            <div class='col-md-12'>
                                <table class='table table-bordered datatable'>
                                    <thead>
                                        <th>Nominee Information</th>
                                        <th>Average Points (Out of 18)</th>
                                        <th>Award Towards</th>
                                        <th>Recommended By</th>
                                        <th>Comments</th>
                                        <th>Justification & Attachments</th>
                                        <th>Action</th>
                                    </thead>
                                    <tbody>
                                        <% @best_team_nominations.each do |nomination| %>
                                            <tr id=<%=  nomination.id %>>
                                                 <td>
                                                    <% nomination.nominees.each_with_index do |nominee, index| %>
                                                        <% nominee = nominee.user %>
                                                        <p>
                                                            <b><%= index+1 %>. <%= nominee.employee.name %></b> (<%= nominee.employee.emp_code %>)<br>
                                                            <%= nominee.employee.department %>
                                                        </p>
                                                    <% end %>
                                                </td>
                                                <td class='action_td'><h2><%= nomination.ratings.map(&:value).reduce(&:+)%></h2></td>
                                                <td><%= raw(nomination.summary) %></td>
                                                <td>
                                                    <% if nomination.state != 'rejected' %>
                                                        <% nomination.approvers.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% else %>
                                                        <% nomination.rejectors.each do |r| %>
                                                            <li><%= "#{Employee.find(r).name} (#{Employee.find(r).emp_code})" %></li>
                                                        <% end %>
                                                    <% end%>
                                                </td>
                                                <td>
                                                    <%= nomination.state != 'rejected' ? raw(nomination.l1_approval_reason) : raw(nomination.l1_rejection_reason) %>
                                                </td>
                                                <td class='action_td'>
                                                    Justifications
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                    Attachments
                                                    <button class='btn btn-primary btn-sm'><i class='material-icons'>remove_red_eye</i></button><br>
                                                </td>
                                                <td class='action_td'>
                                                    <% if nomination.state != 'approved' %>
                                                        <% if nomination.state != 'rejected' %>
                                                            <button class='btn btn-success btn-sm' onclick="approve(<%=  nomination.id %>)"> Approve <i class='material-icons'>done</i></button>
                                                            <br>
                                                            <button class='btn btn-danger btn-sm' onclick="reject(<%=  nomination.id %>) ">Reject <i class='material-icons'>clear</i></button>
                                                        <% else %>
                                                            <h5>Rejected</h5>
                                                        <% end %>
                                                    <% else %>
                                                        <h5>Approved</h5>
                                                    <% end %>
                                                </td>
                                            </tr>
                                        <% end %>
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
<!-- Accept/Reject Modal-->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class='row'>
            <div class='col-md-12'>
                <h5><span class='action_mode'></span> recommended By</h5>
                <%= select_tag "subcommittee_list", options_from_collection_for_select(@commitee_members, 'user_id', 'emp_code'), {id: "commitee_member", multiple: true, style: 'width: 200px'} %>
            </div>
        </div>
        <br>
        <button name='action_button' class='btn pull-right' onclick="doAction()"></button>
    </div>
</div>
<script src="https://cdn.ckeditor.com/4.13.0/standard/ckeditor.js"></script>
<script>
    $(document).ready(function() {
        CKEDITOR.replace('comments');
        $('#commitee_member').select2({'placeholder':'Select Members'});
        $('#award').select2({'placeholder':'Select Members'});
    });
    var span = document.getElementsByClassName("close")[0];
    var modal = document.getElementById("myModal");
    span.onclick = function() {
        modal.style.display = "none";
    }
    window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        }
    }
    function showModal() {
        modal.style.display = "block";
    }

    function closeModal() {
        modal.style.display = "none";
    }

    function doSwitch(mode) {
        $('.tab-pane').removeClass('in active');
        $('#'+mode).addClass('in active');
        $('.tab').parent().removeClass('active');
        $('#btn'+mode).parent().addClass('active');
    }

    var nomination_id = -1;
    var action_mode = '';
    
    function approve(id)
    {
        nomination_id = id;
        action_mode = 'a';
        makeup();
    }

    function reject(id)
    {
        nomination_id = id;
        action_mode = 'r';
        makeup();
    }

    function makeup()
    {
        if(action_mode == 'a')
        {
            $('.action_mode').html("Approval");
            $('button[name=action_button]').removeClass('btn-danger').addClass('btn-success').html("Approve");
        }
        else{
            $('.action_mode').html("Rejection");
            $('button[name=action_button]').removeClass('btn-success').addClass('btn-danger').html("Reject");
        }
        showModal();
    }

    function doAction() {
        var list_of_memebers = $('#commitee_member').val();
        var url = '/nominations/' + nomination_id + '/l2_approval';
        if(list_of_memebers != ''){
            //$.ajax on success
            closeModal();
            $('#'+nomination_id).fadeOut();
            if(action_mode == 'a'){
                var data = {
                    members: list_of_memebers,
                    action_mode: 'approve'
                }
                $.ajax({
                    type: "POST",
                    url: url,
                    data: JSON.stringify(data),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        //$.ajax on success
                        closeModal();
                        $('#commitee_member').val(null).trigger('change');
                        $.notify("Nomination Approved","success");
                    },
                });
            } else {
                var data = {
                    members: list_of_memebers,
                    action_mode: 'reject'
                }
                $.ajax({
                    type: "POST",
                    url: url,
                    data: JSON.stringify(data),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        //$.ajax on success
                        closeModal();
                        $('#commitee_member').val(null).trigger('change');
                        $.notify("Nomination Rejected","success");
                    },
                });
            }
        } else{
            $.notify('Please Select Members');
        }

    }

    function submitVerdict() {
        var comments = CKEDITOR.instances.comments.getData();
        var award_id = $('#award').val();
        var url = '/awards/' + award_id + '/add_comment_to_award'
        if(comments){
            var data = {
                final_verdict_text: comments
            }
            $.ajax({
                type: "POST",
                url: url,
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    //$.ajax on success
                    closeModal();
                    $('#award').val(null).trigger('change');
                    CKEDITOR.instances.comments.setData('');
                    $.notify("Comment Updated Successfully","success")
                },
            });
        //$.ajax on success
        }else{
            $.notify("Please Enter Comment");
        }
    }
</script>
